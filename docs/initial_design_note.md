# **LLMを活用したチャットアプリ初期設計メモ**

## **目的**
LLMを活用したセキュアなチャットアプリを開発するため、Firebase Authentication と Google Cloud IAM を活用して認証・認可をクラウド側で吸収し、アプリケーションの開発負担を軽減する。開発はテスト駆動で進め、MVPを基に段階的に拡張する。

---

## **全体構成**
```
[クライアント (Flutter)] -> [バックエンド (FastAPI)] -> [Google Cloud (IAM, Firebase)]
```

1. **クライアント (Flutter)**:  
   - Firebase Authentication でログインし、トークンを取得。
   - トークンをバックエンドAPIに送信して認証・認可を行う。
2. **バックエンド (FastAPI)**:  
   - Firebaseトークンを検証し、認可されたリソースへのアクセスを提供。
3. **Google Cloud**:  
   - IAMでリソース単位のアクセス制御を実施。

---

## **PBI一覧**

### **カテゴリ: ユーザー認証**

| PBI ID | 機能                                   | ユーザーストーリー                                                                                                   | 受け入れ条件                                                                                                   | 優先度 | 開発難易度 |
|--------|----------------------------------------|--------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------|--------|------------|
| 1-1    | Firebase Authenticationによるログイン | ユーザーとして、メールアドレスとパスワードでログインし、自分専用のデータや会話を利用したい。                            | 1. 正しい認証情報でログイン成功。<br>2. 誤った認証情報でエラー表示。<br>3. トークンが発行される。                  | 高     | 低         |
| 1-3    | トークンの検証                        | バックエンド開発者として、不正なアクセスを防ぐためにトークンを検証したい。                                            | 1. 有効なトークンでリクエスト成功。<br>2. 無効なトークンで401エラー。<br>3. 期限切れトークンで401エラー。          | 高     | 低         |
| 1-4    | ログアウト                             | ユーザーとして、アプリから安全にログアウトしたい。                                                                    | 1. トークン無効化。<br>2. ログアウト成功後、ログイン画面に遷移。                                              | 中     | 低         |

---

### **カテゴリ: チャット機能**

| PBI ID | 機能                                | ユーザーストーリー                                                                                                   | 受け入れ条件                                                                                                   | 優先度 | 開発難易度 |
|--------|-------------------------------------|--------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------|--------|------------|
| 2-1    | ユーザー間チャット                  | ユーザーとして、他のユーザーとリアルタイムでメッセージを交換したい。                                                  | 1. メッセージがリアルタイムで配信される。<br>2. Firestoreに保存される。<br>3. 送信失敗時にエラー表示。             | 高     | 中         |
| 2-2    | LLMとの会話                         | ユーザーとして、AIと会話して質問に答えてもらいたい。                                                                  | 1. 入力メッセージがLLMに送信される。<br>2. LLMの応答がリアルタイムで表示される。<br>3. 通信エラーでエラー表示。   | 高     | 中         |
| 2-3    | メッセージ履歴の保存                | ユーザーとして、過去のチャット履歴を保存して後で確認したい。                                                          | 1. Firestoreに保存される。<br>2. 再ログイン後でも履歴表示。<br>3. 保存失敗時にエラー表示。                       | 高     | 中         |

---

### **カテゴリ: セキュリティと認可**

| PBI ID | 機能                                | ユーザーストーリー                                                                                                   | 受け入れ条件                                                                                                   | 優先度 | 開発難易度 |
|--------|-------------------------------------|--------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------|--------|------------|
| 3-1    | トークンの有効期限チェック          | システム管理者として、期限切れのトークンを無効化してセッションを保護したい。                                          | 1. 期限切れトークンで401エラー。<br>2. 有効トークンで通常処理。<br>3. 再ログイン後に新しいトークン発行。           | 高     | 低         |
| 3-2    | Google Cloud IAMによる認可設定      | システム管理者として、IAMを利用してリソース単位のアクセス制御を行いたい。                                              | 1. IAM許可ユーザーがリソースにアクセス成功。<br>2. IAM制限ユーザーで403エラー。<br>3. IAM変更がリアルタイム反映。   | 高     | 中         |
| 3-3    | 通信の暗号化                        | ユーザーとして、通信内容が暗号化されて安全に送受信されることを望む。                                                  | 1. API通信がHTTPSで行われる。<br>2. HTTP通信がブロックされる。<br>3. HTTPSエラーでエラーメッセージ表示。           | 高     | 低         |

---

### **カテゴリ: ユーザーインターフェース**

| PBI ID | 機能                                | ユーザーストーリー                                                                                                   | 受け入れ条件                                                                                                   | 優先度 | 開発難易度 |
|--------|-------------------------------------|--------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------|--------|------------|
| 4-1    | チャット画面                        | ユーザーとして、直感的に操作できるチャット画面を使用したい。                                                          | 1. メッセージ送受信が表示される。<br>2. 長文メッセージが折り返し表示。<br>3. 入力フォームが正常動作。               | 高     | 中         |

---

## **MVP (最小限のプロダクト)**

### **選定基準**
- ユーザーが基本的な機能を利用できる。
- セキュリティと基本的な価値提供が実現可能。
- 短期間で開発可能。

### **MVP対象PBI**
| PBI ID | 機能                                   |
|--------|----------------------------------------|
| 1-1    | Firebase Authenticationによるログイン |
| 1-3    | トークンの検証                        |
| 2-1    | ユーザー間チャット                    |
| 2-2    | LLMとの会話                           |
| 3-1    | トークンの有効期限チェック            |
| 3-3    | 通信の暗号化                          |
| 4-1    | チャット画面                          |

---

## **優先順位**

| 優先度 | 内容                                                                                   |
|--------|----------------------------------------------------------------------------------------|
| 高     | ユーザー認証 (1-1, 1-3), 基本チャット機能 (2-1, 2-2), セキュリティ対策 (3-1, 3-3)       |
| 中     | IAM認可設定 (3-2), メッセージ履歴保存 (2-3)                                             |
| 低     | 高度な検索機能 (将来的な機能拡張として検討)                                            |

